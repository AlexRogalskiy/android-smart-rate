language: android
dist: trusty

branches:
  only:
    - master

#android:
#  components:
#    - tools
#    - platform-tools

#    - build-tools-29.0.2
#    - android-21
#    - android-29
#
#    - extra-google-m2repository
#    - extra-android-m2repository
#
#     - sys-img-x86-android-29
#    - sys-img-armeabi-v7a-android-21

before_cache:
  - rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
  - rm -fr $HOME/.gradle/caches/*/plugin-resolution/

cache:
  directories:
    - $HOME/android-sdk-dl
    - $HOME/android-sdk

    - $HOME/.gradle/caches/
    - $HOME/.gradle/wrapper/

    - $HOME/.android/build-cache

env:
  - ANDROID_HOME=$HOME/android-sdk

install:
  - if test ! -e $HOME/android-sdk-dl/sdk-tools.zip ; then curl https://dl.google.com/android/repository/sdk-tools-linux-4333796.zip > $HOME/android-sdk-dl/sdk-tools.zip ; fi
  - unzip -qq -n $HOME/android-sdk-dl/sdk-tools.zip -d $HOME/android-sdk

  - echo y | $HOME/android-sdk/tools/bin/sdkmanager 'platform-tools' > /dev/null
  - echo y | $HOME/android-sdk/tools/bin/sdkmanager 'build-tools;29.0.2' > /dev/null
  - echo y | $HOME/android-sdk/tools/bin/sdkmanager 'platforms;android-29' > /dev/null

before_script:
  - echo no | android create avd --force -n test -t android-21 --abi armeabi-v7a -c 100M
  - emulator -avd test -no-audio -no-window &
  - android-wait-for-emulator
  - adb shell input keyevent 82 &

script:
  - "./gradlew :library:clean :library:build :library:connectedCheck -PdisablePreDex --stacktrace"
  - "./gradlew clean build connectedCheck -PdisablePreDex --stacktrace"
  - "./gradlew clean build"

deploy:
  provider: script
  script: "./gradlew :clean :library:assembleRelease :library:bintrayUpload"
  cleanup: false
  on:
    branch: master